<% content_for :title, "Chat IA - Assistant Primes Services" %>

<div class="min-h-screen bg-gray-50 flex flex-col">
  <!-- Header du chat -->
  <header class="bg-white shadow-sm border-b border-gray-200 px-4 py-3">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
          <span class="text-white text-lg">ü§ñ</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold text-gray-900">Assistant Primes Services</h1>
          <p class="text-sm text-gray-600">Expert en subsides belges ‚Ä¢ Disponible 24/7</p>
        </div>
      </div>

      <div class="flex items-center space-x-2">
        <button
          data-action="click->ai-chat#resetChat"
          class="text-gray-600 hover:text-gray-800 px-3 py-1 rounded text-sm transition-colors"
          title="Nouvelle conversation"
        >
          üîÑ Reset
        </button>

        <button
          data-action="click->ai-chat#completeChat"
          class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors"
          title="Terminer la conversation"
        >
          ‚úì Terminer
        </button>
      </div>
    </div>
  </header>

  <!-- Zone de chat -->
  <main class="flex-1 flex flex-col max-w-4xl mx-auto w-full">

    <!-- Messages container -->
    <div
      data-ai-chat-target="messages"
      class="flex-1 overflow-y-auto px-4 py-6 space-y-4"
      style="max-height: calc(100vh - 200px);"
    >

      <!-- Message de bienvenue -->
      <div class="flex justify-start mb-4">
        <div class="bg-gray-100 text-gray-800 rounded-lg px-4 py-3 max-w-md">
          <div class="flex items-start space-x-2">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
              <span class="text-white text-xs">ü§ñ</span>
            </div>
            <div class="flex-1">
              <p class="text-sm">
                Bonjour ! Je suis votre assistant sp√©cialis√© en <strong>primes et subsides belges</strong>.
                <br><br>
                Je connais les <strong>324 subsides disponibles</strong> et je peux vous aider √† :
                <br>
                ‚Ä¢ Calculer vos montants de primes
                <br>
                ‚Ä¢ Identifier les aides selon votre r√©gion
                <br>
                ‚Ä¢ Vous guider dans vos d√©marches
                <br><br>
                Que puis-je faire pour vous aujourd'hui ?
              </p>
              <span class="text-xs opacity-75 block mt-2">
                <%= Time.current.strftime('%H:%M') %>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Historique existant -->
      <% if @conversation_history.present? %>
        <% @conversation_history.each do |message| %>
          <% if message['role'] == 'user' %>
            <div class="flex justify-end mb-4">
              <div class="bg-blue-500 text-white rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
                <p class="text-sm"><%= message['content'] %></p>
                <span class="text-xs opacity-75 block mt-1">
                  <%= Time.parse(message['timestamp']).strftime('%H:%M') rescue 'N/A' %>
                </span>
              </div>
            </div>
          <% elsif message['role'] == 'assistant' %>
            <div class="flex justify-start mb-4">
              <div class="bg-gray-100 text-gray-800 rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
                <div class="flex items-start space-x-2">
                  <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                    <span class="text-white text-xs">ü§ñ</span>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm whitespace-pre-wrap"><%= message['content'] %></p>
                    <span class="text-xs opacity-75 block mt-1">
                      <%= Time.parse(message['timestamp']).strftime('%H:%M') rescue 'N/A' %>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <!-- Indicateur de frappe -->
    <div data-ai-chat-target="typingIndicator" class="px-4 hidden"></div>

    <!-- Suggestions rapides -->
    <div data-ai-chat-target="suggestions" class="px-4 py-2">
      <div class="suggestions-container">
        <p class="text-sm text-gray-600 mb-2">Suggestions pour commencer :</p>
        <div class="flex flex-wrap gap-2">
          <button
            data-action="click->ai-chat#sendSuggestion"
            data-message="Combien puis-je avoir pour isoler ma maison ?"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-2 rounded-full transition-colors"
          >
            üí∞ Primes isolation
          </button>

          <button
            data-action="click->ai-chat#sendSuggestion"
            data-message="Quelles sont les aides pour une pompe √† chaleur ?"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-2 rounded-full transition-colors"
          >
            üî• Aide chauffage
          </button>

          <button
            data-action="click->ai-chat#sendSuggestion"
            data-message="Comment r√©nover avec les subsides wallons ?"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-2 rounded-full transition-colors"
          >
            üè† R√©novation globale
          </button>

          <button
            data-action="click->ai-chat#sendSuggestion"
            data-message="Qui √™tes-vous et comment m'aidez-vous ?"
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-2 rounded-full transition-colors"
          >
            ‚ÑπÔ∏è √Ä propos
          </button>
        </div>
      </div>
    </div>

    <!-- Zone d'actions -->
    <div data-ai-chat-target="actions" class="px-4 py-2"></div>

    <!-- Zone de saisie -->
    <div class="bg-white border-t border-gray-200 px-4 py-3">
      <div class="flex items-end space-x-2">
        <div class="flex-1">
          <textarea
            data-ai-chat-target="input"
            placeholder="Tapez votre question sur les primes et subsides..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
            rows="1"
            style="min-height: 40px; max-height: 120px;"
          ></textarea>
        </div>

        <button
          data-ai-chat-target="sendButton"
          data-action="click->ai-chat#sendMessage"
          class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg transition-colors font-medium"
          disabled
        >
          <span class="hidden sm:inline">Envoyer</span>
          <span class="sm:hidden">üì§</span>
        </button>
      </div>

      <div class="mt-2 text-xs text-gray-500 text-center">
        Appuyez sur <kbd class="bg-gray-100 px-1 rounded">Entr√©e</kbd> pour envoyer,
        <kbd class="bg-gray-100 px-1 rounded">Shift + Entr√©e</kbd> pour une nouvelle ligne
      </div>
    </div>
  </main>
</div>

<!-- Contr√¥leur Stimulus -->
<div
  data-controller="ai-chat"
  data-ai-chat-conversation-id-value="<%= @conversation_stats[:session_id] %>"
  data-ai-chat-user-type-value="<%= session[:user_type] || 'visiteur' %>"
  data-ai-chat-user-region-value="<%= session[:user_region] || 'wallonie' %>"
  data-ai-chat-api-url-value="/ai"
  class="hidden"
></div>

<!-- Styles CSS personnalis√©s -->
<style>
  /* Animation pour les points de frappe */
  .typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .typing-dots span {
    width: 6px;
    height: 6px;
    background-color: #6b7280;
    border-radius: 50%;
    animation: typing 1.4s infinite;
  }

  .typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.5;
    }
    30% {
      transform: translateY(-10px);
      opacity: 1;
    }
  }

  /* Scroll personnalis√© */
  .messages::-webkit-scrollbar {
    width: 6px;
  }

  .messages::-webkit-scrollbar-track {
    background: #f1f5f9;
  }

  .messages::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
  }

  .messages::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  /* Animation des messages */
  .message {
    animation: messageSlideIn 0.3s ease-out;
  }

  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .max-w-xs {
      max-width: 85%;
    }

    .max-w-md {
      max-width: 85%;
    }
  }
</style>
