<%#
  Partiel pour afficher une bulle de message de chat
  UtilisÃ© dans l'interface de chat IA et potentiellement dans d'autres vues

  Variables requises:
  - role: 'user', 'assistant', ou 'system'
  - content: le contenu du message
  - timestamp: (optionnel) timestamp du message
  - actions: (optionnel) actions disponibles pour ce message
  - metadata: (optionnel) mÃ©tadonnÃ©es du message
%>

<% role ||= 'system' %>
<% timestamp ||= Time.current %>
<% actions ||= [] %>
<% metadata ||= {} %>

<div class="message message-<%= role %> mb-4">
  <% case role %>
  <% when 'user' %>
    <div class="flex justify-end">
      <div class="bg-blue-500 text-white rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
        <p class="text-sm whitespace-pre-wrap"><%= content %></p>
        <span class="text-xs opacity-75 block mt-1">
          <%= timestamp.strftime('%H:%M') %>
        </span>
      </div>
    </div>

  <% when 'assistant' %>
    <div class="flex justify-start">
      <div class="bg-gray-100 text-gray-800 rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
        <div class="flex items-start space-x-2">
          <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <span class="text-white text-xs">ðŸ¤–</span>
          </div>
          <div class="flex-1">
            <div class="text-sm whitespace-pre-wrap">
              <%= simple_format(content, {}, wrapper_tag: "div") %>
            </div>

            <!-- Actions suggÃ©rÃ©es -->
            <% if actions.present? %>
              <div class="mt-3 space-y-1">
                <% actions.each do |action| %>
                  <%
                    button_class = action[:primary] ?
                      "bg-blue-500 text-white hover:bg-blue-600" :
                      "bg-gray-200 text-gray-700 hover:bg-gray-300"
                  %>

                  <% case action[:type] %>
                  <% when 'form', 'internal' %>
                    <%= link_to action[:url],
                        class: "inline-block px-3 py-1 rounded text-xs font-medium transition-colors mr-2 mb-1 #{button_class}" do %>
                      <%= action[:label] %>
                    <% end %>

                  <% when 'redirect', 'contact' %>
                    <%= link_to action[:url],
                        target: action[:type] == 'redirect' ? '_blank' : '_self',
                        class: "inline-block px-3 py-1 rounded text-xs font-medium transition-colors mr-2 mb-1 #{button_class}" do %>
                      <%= action[:label] %>
                      <% if action[:type] == 'redirect' %>
                        <span class="ml-1">â†—</span>
                      <% end %>
                    <% end %>

                  <% when 'quick_message' %>
                    <button
                      data-action="click->ai-chat#sendMessage"
                      data-message="<%= action[:message] %>"
                      class="inline-block px-3 py-1 rounded text-xs font-medium transition-colors mr-2 mb-1 <%= button_class %>"
                    >
                      <%= action[:label] %>
                    </button>
                  <% end %>
                <% end %>
              </div>
            <% end %>

            <span class="text-xs opacity-75 block mt-2">
              <%= timestamp.strftime('%H:%M') %>
              <% if metadata[:model_used] %>
                â€¢ <%= metadata[:model_used] %>
              <% end %>
            </span>
          </div>
        </div>
      </div>
    </div>

  <% when 'system' %>
    <div class="flex justify-center">
      <div class="bg-yellow-100 text-yellow-800 rounded-lg px-3 py-2 text-sm max-w-md text-center">
        <%= content %>
      </div>
    </div>

  <% else %>
    <!-- Fallback pour types de messages inconnus -->
    <div class="flex justify-center">
      <div class="bg-gray-100 text-gray-800 rounded-lg px-3 py-2 text-sm max-w-md">
        <strong><%= role.humanize %>:</strong> <%= content %>
      </div>
    </div>
  <% end %>
</div>
